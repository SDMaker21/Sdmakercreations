<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta diseños, logos y ediciones — 0416 3403334</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="hero">
    <div class="card">
      <div class="logo">
        <!-- Preferir archivo físico; script hará fallback si no existe -->
        <img src="assets/logo.jpeg" alt="Logo" class="logo-img" />
      </div>
      <h1>Consulta el tipo de diseños, logos y ediciones</h1>
      <p class="lead">Ofrecemos diseños, logos y ediciones personalizados.</p>
      <!-- Botón único para abrir panel de contacto (moved to top) -->
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:24px;">
        <button class="btn" id="openContactBtn" type="button" title="Abrir contacto">Contáctanos</button>
      </div>
    </div>
    <div class="sections">
      <section class="section-card">
        <h2>Galería</h2>
        <div id="galleryPreview" class="gallery-preview" tabindex="0" aria-label="Galería">
          <div class="preview-overlay">Galería</div>
        </div>
      </section>
      <section class="section-card">
        <h2>Quién soy</h2>
        <div id="profilePreview" class="gallery-preview profile-preview" tabindex="0" aria-label="Quién soy">
          <img src="assets/logo.jpeg" alt="SDMaker" class="profile-logo" />
          <div class="preview-overlay">Quién soy</div>
        </div>
      </section>
      <section class="section-card">
        <h2>Redes</h2>
        <div id="socialPreview" class="social-preview" tabindex="0" aria-label="Redes sociales">
          <img src="assets/logo_redes.png" alt="Redes" class="social-icon" />
          <div class="preview-overlay">Redes</div>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="card footer-card">
      <!-- Footer minimal, content moved to top -->
    </div>
  </footer>

  <!-- User dropdown menu (login & register) -->
  <div id="userMenu" class="user-menu" hidden aria-hidden="true" role="menu">
    <div class="user-menu-inner">
      <h3 style="margin-top:0;margin-bottom:6px;">Acceso</h3>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
        <div id="gsiButtonContainer"></div>
      </div>
      <!-- EmailJS removed: only Google Client ID is supported now -->
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
        <label for="googleClientId" style="margin:0;">Google Client ID (643541215288-tlnf8qupa51voann4iifvpg5diivv31p.apps.googleusercontent.com)</label>
        <input id="googleClientId" type="text" placeholder="G...apps.googleusercontent.com" style="flex:1;" />
        <button id="saveGoogleClientIdBtn" class="btn">Guardar</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
        <label for="googleClientSecret" style="margin:0;">Google Client Secret (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)</label>
        <input id="googleClientSecret" type="password" placeholder="Secreto del cliente" style="flex:1;" />
        <button id="saveGoogleClientSecretBtn" class="btn">Guardar</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:flex-end;">
        <button id="logoutBtn" class="btn secondary">Cerrar sesión</button>
      </div>
      <div id="authMsg" style="margin-top:10px;color:#9fe6a0;display:none;">Listo</div>
    </div>
  </div>
  <!-- Social modal (input & save links) -->
  <div id="socialModal" class="contact-panel" aria-hidden="true" role="dialog" aria-labelledby="socialModalTitle">
    <div class="contact-panel__inner" role="document">
      <button id="closeSocialModalBtn" class="contact-close" aria-label="Cerrar">✕</button>
      <h2 id="socialModalTitle">Redes</h2>
      <p>Introduce tus enlaces para que los visitantes puedan contactarte directamente.</p>
      <label for="instagramInput">Instagram</label>
      <input id="instagramInput" type="url" placeholder="https://instagram.com/tu_usuario" />
      <label for="facebookInput">Facebook</label>
      <input id="facebookInput" type="url" placeholder="https://facebook.com/tu_pagina" />
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="saveSocialBtn" class="btn">Guardar</button>
        <button id="openInstagramBtn" class="btn secondary" style="display:none;">Abrir Instagram</button>
        <button id="openFacebookBtn" class="btn secondary" style="display:none;">Abrir Facebook</button>
      </div>
      <div id="socialMessage" style="margin-top:10px;color:green;display:none;">Guardado</div>
    </div>
  </div>
  <!-- Profile modal (opens from profile preview) -->
  <div id="profileModal" class="contact-panel" aria-hidden="true" role="dialog" aria-labelledby="profileModalTitle">
    <div class="contact-panel__inner" role="document">
      <button id="closeProfileModalBtn" class="contact-close" aria-label="Cerrar">✕</button>
      <h2 id="profileModalTitle">Quién soy</h2>
      <p>Soy un estudiante con las ganas de ayudar en la creación de diseños y logos, así como también de videos. Razonando el precio dependiendo del trabajo y del tiempo que se tarde; busco ayudar de una forma mutua: consultar y yo trabajo según la necesidad. Soy confiable.</p>
      <p class="signature">Santiago Medina "SDMaker"</p>
    </div>
  </div>
  <!-- Gallery modal (opens from gallery preview) -->
  <div id="galleryModal" class="contact-panel" aria-hidden="true" role="dialog" aria-labelledby="galleryModalTitle">
    <div class="contact-panel__inner" role="document">
      <button id="closeGalleryModalBtn" class="contact-close" aria-label="Cerrar">✕</button>
      <h2 id="galleryModalTitle">Galería</h2>
      <div id="galleryModalContent" class="works-gallery">
        <!-- Images will be loaded here -->
      </div>
    </div>
  </div>
  <!-- Panel desplegable de contacto (modal) -->
  <div id="contactPanel" class="contact-panel" aria-hidden="true" role="dialog" aria-labelledby="contactTitle">
    <div class="contact-panel__inner" role="document">
      <button id="closeContactBtn" class="contact-close" aria-label="Cerrar">✕</button>
      <h2 id="contactTitle">Contáctanos</h2>
      <p>Puedes escribirnos por WhatsApp al número <strong>0416 3403334</strong> o abrir el chat directamente.</p>
      <a class="btn contact-action" id="whatsappLink" href="https://wa.me/584163403334" target="_blank" rel="noopener noreferrer">Abrir WhatsApp</a>
    </div>
  </div>

  <!-- Ventana: Trabajos realizados (upload + galería) -->
  <div id="worksPanel" class="contact-panel works-panel" aria-hidden="true" role="dialog" aria-labelledby="worksTitle">
    <div class="contact-panel__inner" role="document">
      <button id="closeWorksBtn" class="contact-close" aria-label="Cerrar">✕</button>
      <h2 id="worksTitle">Trabajos realizados</h2>

      <div class="upload-area" id="uploadArea">
        <p>Arrastra tus archivos aquí o <button class="linklike" id="browseBtn" type="button">selecciona archivos</button></p>
        <input id="fileInputWorks" type="file" multiple style="display:none;" />
        <div id="uploadQueue" class="upload-queue" aria-live="polite"></div>
      </div>

      <div class="gallery-panel">
        <button id="galleryPrevBtn" class="gallery-nav-btn gallery-nav-left" aria-label="Anterior" title="Anterior">‹</button>
        <div id="worksGallery" class="works-gallery">
          <p class="muted">No hay trabajos aún. Sube archivos para mostrarlos aquí.</p>
        </div>
        <button id="galleryNextBtn" class="gallery-nav-btn gallery-nav-right" aria-label="Siguiente" title="Siguiente">›</button>
      </div>
    </div>
  </div>

  <!-- (El recuadro 'Redes' duplicado fue eliminado; permanece el que está junto a 'Quién soy') -->

  <!-- Lightbox overlay -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lightbox-inner">
      <button id="lightboxClose" class="lightbox-close" aria-label="Cerrar">✕</button>
      <button id="lightboxPrev" class="lightbox-prev" aria-label="Anterior">❮</button>
      <img id="lightboxImg" class="lightbox-img" src="" alt="" />
      <button id="lightboxNext" class="lightbox-next" aria-label="Siguiente">❯</button>
    </div>
    <div id="lightboxCaption" class="lightbox-caption" aria-live="polite"></div>
  </div>
  <script>
    // Intento de cargar primero la imagen desde assets/logo.jpeg.
    // Si falla, dejamos el contenido embebido actual como fallback.
    document.addEventListener('DOMContentLoaded', function() {
      var logoImg = document.querySelector('.logo img');
      if (!logoImg) return;
      // Asignar un id por si acaso
      logoImg.id = logoImg.id || 'mainLogo';
      // Intentar cargar el archivo físico primero
      logoImg.src = 'assets/logo.jpeg';
      logoImg.onerror = function() {
        this.onerror = null;
        // Fallback: pequeño SVG inline para asegurar que se vea algo
        this.src = 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22100%22><rect width=%22200%22 height=%22100%22 fill=%22%230b3d91%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2216%22 fill=%22white%22>Logo</text></svg>';
      };
      // Ensure profile preview logo has same fallback
      var profileLogo = document.querySelector('.profile-logo');
      if (profileLogo){
        profileLogo.onerror = function(){ this.onerror = null; this.src = 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22><rect width=%22120%22 height=%22120%22 fill=%22%230b3d91%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22white%22>SDMaker</text></svg>'; };
        // prefer asset if not already set (img src is in markup but ensure same behavior)
        if (!profileLogo.src || profileLogo.src.indexOf('data:') === 0) profileLogo.src = 'assets/logo.jpeg';
      }

      // Social preview image fallback: intenta cargar asset y si falla usa la imagen local 'logo_redes.png' o un SVG embebido
      var socialIcon = document.querySelector('.social-preview .social-icon');
      if (socialIcon){
        socialIcon.onerror = function(){ this.onerror = null; this.src = 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 448 512%22 width=%2256%22 height=%2256%22><linearGradient id=%22g%22 x1=%220%25%22 x2=%22100%25%22 y1=%220%25%22 y2=%22100%25%22><stop offset=%220%25%22 stop-color=%22%236ab04a%22/><stop offset=%2250%25%22 stop-color=%22%234cc3a1%22/><stop offset=%22100%25%22 stop-color=%22%233aa6d8%22/></linearGradient><rect width=%22448%22 height=%22512%22 rx=%2280%22 fill=%22url(%23g)%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2216%22 fill=%22white%22>Redes</text></svg>'; };
        if (!socialIcon.src || socialIcon.src.indexOf('data:') === 0) socialIcon.src = 'assets/logo_redes.png';
      }

        // --- Panel de contacto: abrir / cerrar ---
        var openBtn = document.getElementById('openContactBtn');
        var contactPanel = document.getElementById('contactPanel');
        var closeBtn = document.getElementById('closeContactBtn');

        function showContact() {
          contactPanel.classList.add('open');
          contactPanel.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          // focus en primer elemento del modal
          closeBtn && closeBtn.focus();
        }

        function hideContact() {
          contactPanel.classList.remove('open');
          contactPanel.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
          openBtn && openBtn.focus();
        }

        openBtn && openBtn.addEventListener('click', function(){ showContact(); });
        closeBtn && closeBtn.addEventListener('click', function(){ hideContact(); });
        // Cerrar al hacer click fuera del panel interno
        contactPanel && contactPanel.addEventListener('click', function(e){ if (e.target === contactPanel) hideContact(); });
        // Cerrar con Escape
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && contactPanel.classList.contains('open')) hideContact(); });

      // --- Perfil: preview -> modal (abierto en el centro) ---
      var profilePreview = document.getElementById('profilePreview');
      var profileModal = document.getElementById('profileModal');
      var closeProfileModalBtn = document.getElementById('closeProfileModalBtn');

      function showProfileModal(){
        profileModal.classList.add('open'); profileModal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
        closeProfileModalBtn && closeProfileModalBtn.focus();
      }
      function hideProfileModal(){
        profileModal.classList.remove('open'); profileModal.setAttribute('aria-hidden','true'); document.body.style.overflow = '';
        profilePreview && profilePreview.focus();
      }

      profilePreview && profilePreview.addEventListener('click', showProfileModal);
      profilePreview && profilePreview.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showProfileModal(); } });
      closeProfileModalBtn && closeProfileModalBtn.addEventListener('click', hideProfileModal);
      profileModal && profileModal.addEventListener('click', function(e){ if (e.target === profileModal) hideProfileModal(); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && profileModal.classList.contains('open')) hideProfileModal(); });

      // --- Gallery: preview -> modal ---
      var galleryPreview = document.getElementById('galleryPreview');
      var galleryModal = document.getElementById('galleryModal');
      var closeGalleryModalBtn = document.getElementById('closeGalleryModalBtn');
      var galleryModalContent = document.getElementById('galleryModalContent');

      function showGalleryModal(){
        renderGalleryModal();
        galleryModal.classList.add('open'); galleryModal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
        closeGalleryModalBtn && closeGalleryModalBtn.focus();
      }
      function hideGalleryModal(){
        galleryModal.classList.remove('open'); galleryModal.setAttribute('aria-hidden','true'); document.body.style.overflow = '';
        galleryPreview && galleryPreview.focus();
      }

      galleryPreview && galleryPreview.addEventListener('click', showGalleryModal);
      galleryPreview && galleryPreview.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showGalleryModal(); } });
      closeGalleryModalBtn && closeGalleryModalBtn.addEventListener('click', hideGalleryModal);
      galleryModal && galleryModal.addEventListener('click', function(e){ if (e.target === galleryModal) hideGalleryModal(); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && galleryModal.classList.contains('open')) hideGalleryModal(); });

      function renderGalleryModal(){
        if (!galleryModalContent) return;
        galleryModalContent.innerHTML = '';
        if (!galleryItems || galleryItems.length === 0){
          galleryModalContent.innerHTML = '<p class="muted">No hay imágenes en la galería.</p>';
          return;
        }
        var grid = document.createElement('div'); grid.className = 'works-grid horizontal-2';
        galleryItems.forEach(function(it, idx){
          var card = document.createElement('div'); card.className = 'work-item';
          var img = document.createElement('img'); img.src = it.src || URL.createObjectURL(it.blob); img.alt = it.name; img.className = 'work-thumb'; card.appendChild(img);
          img.dataset.index = idx;
          img.addEventListener('click', function(){ showLightbox(idx); });
          grid.appendChild(card);
        });
        galleryModalContent.appendChild(grid);
      }

      // --- Social modal: open / save links ---
      var socialPreview = document.getElementById('socialPreview');
      var socialModal = document.getElementById('socialModal');
      var closeSocialModalBtn = document.getElementById('closeSocialModalBtn');
      var instagramInput = document.getElementById('instagramInput');
      var facebookInput = document.getElementById('facebookInput');
      var saveSocialBtn = document.getElementById('saveSocialBtn');
      var socialMessage = document.getElementById('socialMessage');
      var openInstagramBtn = document.getElementById('openInstagramBtn');
      var openFacebookBtn = document.getElementById('openFacebookBtn');

      function loadSocialLinks(){
        try{
          var raw = localStorage.getItem('social_links');
          if (!raw) return {};
          return JSON.parse(raw);
        }catch(e){return{}};
      }

      // Initialize default social links if not present
      if (!localStorage.getItem('social_links')) {
        saveSocialLinks({
          instagram: 'https://www.instagram.com/sanmedin_41/',
          facebook: 'https://www.facebook.com/santiago.medina.515897'
        });
      }

      function saveSocialLinks(obj){
        localStorage.setItem('social_links', JSON.stringify(obj));
      }

      function showSocialModal(){
        var links = loadSocialLinks();
        instagramInput.value = links.instagram || '';
        facebookInput.value = links.facebook || '';
        updateSocialButtons();
        socialModal.classList.add('open'); socialModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
        closeSocialModalBtn && closeSocialModalBtn.focus();
      }

      function hideSocialModal(){
        socialModal.classList.remove('open'); socialModal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
        socialPreview && socialPreview.focus();
      }

      function updateSocialButtons(){
        var links = loadSocialLinks();
        if (links.instagram){ openInstagramBtn.style.display='inline-block'; openInstagramBtn.onclick = function(){ window.open(links.instagram, '_blank'); } } else { openInstagramBtn.style.display='none'; }
        if (links.facebook){ openFacebookBtn.style.display='inline-block'; openFacebookBtn.onclick = function(){ window.open(links.facebook, '_blank'); } } else { openFacebookBtn.style.display='none'; }
      }

      function sanitizeUrl(v){ if (!v) return ''; v = v.trim(); if (!v) return ''; if (!/^https?:\/\//i.test(v)) v = 'https://' + v; return v; }

      socialPreview && socialPreview.addEventListener('click', showSocialModal);
      socialPreview && socialPreview.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showSocialModal(); } });
      closeSocialModalBtn && closeSocialModalBtn.addEventListener('click', hideSocialModal);
      socialModal && socialModal.addEventListener('click', function(e){ if (e.target === socialModal) hideSocialModal(); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && socialModal.classList.contains('open')) hideSocialModal(); });

      saveSocialBtn && saveSocialBtn.addEventListener('click', function(){
        var instagram = sanitizeUrl(instagramInput.value);
        var facebook = sanitizeUrl(facebookInput.value);
        // Solo admin puede guardar enlaces
        if (!isAdmin()){ alert('Solo el administrador puede guardar enlaces.'); return; }
        saveSocialLinks({instagram: instagram, facebook: facebook});
        socialMessage.style.display = 'block'; setTimeout(function(){ socialMessage.style.display='none'; }, 1800);
        updateSocialButtons();
      });

      // --- Auth: admin / guest handling ---
      var openAuthBtn = document.getElementById('openAuthBtn');
      var userMenu = document.getElementById('userMenu');
      var authStatus = document.getElementById('authStatus');
      var googleClientIdInput = document.getElementById('googleClientId');
      var googleClientSecretInput = document.getElementById('googleClientSecret');
      var gsiButtonContainer = document.getElementById('gsiButtonContainer');
      var saveGoogleClientIdBtn = document.getElementById('saveGoogleClientIdBtn');
      var saveGoogleClientSecretBtn = document.getElementById('saveGoogleClientSecretBtn');
      var logoutBtn = document.getElementById('logoutBtn');
      var authMsg = document.getElementById('authMsg');

      function getSessionUser(){ try{ return JSON.parse(sessionStorage.getItem('user')||'null'); }catch(e){return null;} }
      function setSessionUser(u){ if (!u) sessionStorage.removeItem('user'); else sessionStorage.setItem('user', JSON.stringify(u)); updateAuthUI(); }
      function isAdmin(){ var u = getSessionUser(); if (!u || !u.email) return false; var admin = (localStorage.getItem('admin_email')||'').toLowerCase(); return admin && admin === u.email.toLowerCase(); }

      function updateAuthUI(){ var u = getSessionUser(); if (u && u.email){ authStatus.textContent = u.email; } else { authStatus.textContent = 'Invitado'; }
        // Show/hide upload area
        var uploadArea = document.getElementById('uploadArea'); if (uploadArea) uploadArea.style.display = 'block';
        // update social modal save button visibility
        var saveBtn = document.getElementById('saveSocialBtn'); if (saveBtn) saveBtn.style.display = 'inline-block';
        // re-render gallery to show/hide edit/delete if needed
        renderWorksGallery();
      }

        // toggle user menu (dropdown)
        openAuthBtn && openAuthBtn.addEventListener('click', function(e){ if (!userMenu) return; var expanded = openAuthBtn.getAttribute('aria-expanded') === 'true'; if (expanded){ userMenu.hidden = true; userMenu.setAttribute('aria-hidden','true'); openAuthBtn.setAttribute('aria-expanded','false'); } else { userMenu.hidden = false; userMenu.setAttribute('aria-hidden','false'); openAuthBtn.setAttribute('aria-expanded','true'); // focus and init
          tryInitGoogle(); var curId = localStorage.getItem('google_client_id')||''; googleClientIdInput.value = curId; var curSecret = localStorage.getItem('google_client_secret')||''; googleClientSecretInput.value = curSecret; } e.stopPropagation(); });

        // close menu on outside click or ESC
        document.addEventListener('click', function(e){ if (!userMenu || userMenu.hidden) return; if (openAuthBtn && (openAuthBtn === e.target || openAuthBtn.contains(e.target))) return; if (userMenu.contains(e.target)) return; userMenu.hidden = true; userMenu.setAttribute('aria-hidden','true'); openAuthBtn.setAttribute('aria-expanded','false'); });
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && userMenu && !userMenu.hidden){ userMenu.hidden = true; userMenu.setAttribute('aria-hidden','true'); openAuthBtn.setAttribute('aria-expanded','false'); openAuthBtn && openAuthBtn.focus(); } });

      logoutBtn && logoutBtn.addEventListener('click', function(){ setSessionUser(null); authMsg.style.display='block'; setTimeout(function(){ authMsg.style.display='none'; },900); if (userMenu){ userMenu.hidden = true; openAuthBtn && openAuthBtn.setAttribute('aria-expanded','false'); } });

      // Google Identity Services init
      function tryInitGoogle(){ var id = (localStorage.getItem('google_client_id')|| (googleClientIdInput && googleClientIdInput.value) || '').trim(); if (!id) { gsiButtonContainer.innerHTML = '<div class="muted">Pega el Google Client ID en configuración para habilitar inicio con Google.</div>'; return; } localStorage.setItem('google_client_id', id); // save
        // load script if not present
        if (!window.google || !window.google.accounts || !window.google.accounts.id){ var s = document.createElement('script'); s.src='https://accounts.google.com/gsi/client'; s.async=true; s.defer=true; s.onload = function(){ initGSI(id); }; document.head.appendChild(s); } else { initGSI(id); }
      }

      // EmailJS and OTP flow removed: only Google Client ID login and local admin remain

      function initGSI(clientId){ try{ window.google.accounts.id.initialize({ client_id: clientId, callback: handleCredentialResponse }); gsiButtonContainer.innerHTML = ''; window.google.accounts.id.renderButton(gsiButtonContainer, { theme: 'outline', size: 'large' }); }catch(e){ gsiButtonContainer.innerHTML = '<div class="muted">Error al inicializar Google Sign-In.</div>'; } }

      function parseJwtPayload(token){ try{ var p = token.split('.')[1]; p = p.replace(/-/g,'+').replace(/_/g,'/'); var json = decodeURIComponent(atob(p).split('').map(function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')); return JSON.parse(json); }catch(e){return null;} }

      function handleCredentialResponse(resp){ var payload = parseJwtPayload(resp.credential); if (!payload || !payload.email){ alert('No se obtuvo email desde Google.'); return; } setSessionUser({ email: payload.email, method:'google' }); authMsg.style.display='block'; setTimeout(function(){ authMsg.style.display='none'; },900); }

      // save google client id explicit
      saveGoogleClientIdBtn && saveGoogleClientIdBtn.addEventListener('click', function(){ var v = (googleClientIdInput.value||'').trim(); if (!v) { alert('Introduce un Google Client ID válido'); return; } localStorage.setItem('google_client_id', v); tryInitGoogle(); authMsg.style.display='block'; setTimeout(function(){ authMsg.style.display='none'; },800); });

      // save google client secret explicit
      saveGoogleClientSecretBtn && saveGoogleClientSecretBtn.addEventListener('click', function(){ var v = (googleClientSecretInput.value||'').trim(); if (!v) { alert('Introduce un Google Client Secret válido'); return; } localStorage.setItem('google_client_secret', v); authMsg.style.display='block'; setTimeout(function(){ authMsg.style.display='none'; },800); });

      // initial auth state
      updateAuthUI();

      // --- Ensure admin defaults (set by user) ---
      (function ensureAdminDefaults(){
        try{
          if (!localStorage.getItem('admin_email')){
            localStorage.setItem('admin_email','sm172607q@gmail.com');
          }
          if (!localStorage.getItem('admin_password_hash')){
            // compute hash of provided password and store it
            sha256hex('toroncho21').then(function(h){ localStorage.setItem('admin_password_hash', h); });
          }
          if (!localStorage.getItem('google_client_id')){
            localStorage.setItem('google_client_id','643541215288-tlnf8qupa51voann4iifvpg5diivv31p.apps.googleusercontent.com');
          }
        }catch(e){}
      })();



      // --- Trabajos realizados: upload + IndexedDB gallery ---
      var openWorksBtn = document.getElementById('openWorksBtn');
      var worksPanel = document.getElementById('worksPanel');
      var closeWorksBtn = document.getElementById('closeWorksBtn');
      var fileInput = document.getElementById('fileInputWorks');
      var uploadArea = document.getElementById('uploadArea');
      var browseBtn = document.getElementById('browseBtn');
      var worksGallery = document.getElementById('worksGallery');
      var portfolioGallery = document.getElementById('portfolioGallery');
      var uploadQueue = document.getElementById('uploadQueue');
      var pendingUploads = [];

      function openWorks(){
        worksPanel.classList.add('open');
        worksPanel.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        closeWorksBtn && closeWorksBtn.focus();
        renderWorksGallery();
      }
      openWorksBtn && openWorksBtn.addEventListener('click', openWorks);
      closeWorksBtn && closeWorksBtn.addEventListener('click', function(){
        worksPanel.classList.remove('open');
        worksPanel.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        // devolver foco a la vista previa de la galería si existe
        try{ var preview = document.getElementById('portfolioGallery') && document.getElementById('portfolioGallery').querySelector('.gallery-preview'); if (preview) preview.focus(); }catch(e){}
      });
      worksPanel && worksPanel.addEventListener('click', function(e){ if (e.target === worksPanel) { worksPanel.classList.remove('open'); worksPanel.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; try{ var preview = document.getElementById('portfolioGallery') && document.getElementById('portfolioGallery').querySelector('.gallery-preview'); if (preview) preview.focus(); }catch(e){} } });

      // IndexedDB helpers
      function openDB(){
        return new Promise(function(resolve,reject){
          var req = indexedDB.open('works-db',1);
          req.onupgradeneeded = function(e){ var db = e.target.result; if (!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'id',autoIncrement:true}); };
          req.onsuccess = function(e){ resolve(e.target.result); };
          req.onerror = function(e){ reject(e.target.error); };
        });
      }

      function addFileToDB(file, description){
        return openDB().then(function(db){
          return new Promise(function(resolve,reject){
            var tx = db.transaction('files','readwrite');
            var store = tx.objectStore('files');
            var entry = { name: file.name, type: file.type, blob: file, date: Date.now(), description: description || '' };
            var r = store.add(entry);
            r.onsuccess = function(){ resolve(); };
            r.onerror = function(e){ reject(e.target.error); };
          });
        });
      }

      function updateFileInDB(id, updates){
        return openDB().then(function(db){
          return new Promise(function(resolve,reject){
            var tx = db.transaction('files','readwrite');
            var store = tx.objectStore('files');
            var req = store.get(id);
            req.onsuccess = function(){
              var rec = req.result;
              if (!rec) return resolve();
              Object.assign(rec, updates);
              var r2 = store.put(rec);
              r2.onsuccess = function(){ resolve(); };
              r2.onerror = function(e){ reject(e.target.error); };
            };
            req.onerror = function(e){ reject(e.target.error); };
          });
        });
      }

      function getAllFilesFromDB(){
        return openDB().then(function(db){
          return new Promise(function(resolve,reject){
            var tx = db.transaction('files','readonly');
            var store = tx.objectStore('files');
            var r = store.getAll();
            r.onsuccess = function(){ resolve(r.result); };
            r.onerror = function(e){ reject(e.target.error); };
          });
        });
      }

      function deleteFileFromDB(id){
        return openDB().then(function(db){
          return new Promise(function(resolve,reject){
            var tx = db.transaction('files','readwrite');
            var store = tx.objectStore('files');
            var r = store.delete(id);
            r.onsuccess = function(){ resolve(); };
            r.onerror = function(e){ reject(e.target.error); };
          });
        });
      }

      function createWorkCard(it, index){
        var card = document.createElement('div'); card.className = 'work-item';
        var url = it.src || URL.createObjectURL(it.blob);
        if (it.type && it.type.startsWith('image/')){
          var img = document.createElement('img'); img.src = url; img.alt = it.name; img.className = 'work-thumb'; card.appendChild(img);
          img.dataset.index = index;
          img.addEventListener('click', function(){ showLightbox(index); });
        } else {
          var icon = document.createElement('div'); icon.className = 'work-file'; icon.textContent = it.name; card.appendChild(icon);
        }
        var meta = document.createElement('div'); meta.className = 'work-meta';
        var nameEl = document.createElement('div'); nameEl.className = 'work-name'; nameEl.textContent = it.name; meta.appendChild(nameEl);
        var descEl = document.createElement('div'); descEl.className = 'work-desc'; descEl.textContent = it.description || ''; meta.appendChild(descEl);
        var actions = document.createElement('div'); actions.className = 'work-actions';
        var view = document.createElement('a'); view.href = url; view.target = '_blank'; view.textContent = 'Ver'; view.className = 'linklike'; actions.appendChild(view);
        var dl = document.createElement('a'); dl.href = url; dl.download = it.name; dl.textContent = 'Descargar'; dl.className = 'linklike'; dl.style.marginLeft = '10px'; actions.appendChild(dl);
        var del = document.createElement('button'); del.textContent = 'Eliminar'; del.className = 'btn small danger'; del.style.marginLeft = '10px'; del.addEventListener('click', function(){ deleteFileFromDB(it.id).then(function(){ renderWorksGallery(); }); });
        actions.appendChild(del);
        var edit = document.createElement('button'); edit.textContent = 'Editar'; edit.className = 'btn small'; edit.style.marginLeft = '8px';
        edit.addEventListener('click', function(){
          // Toggle inline edit for description
          if (edit._editing){
            // save
            var input = card.querySelector('.work-desc-input');
            var newDesc = input ? input.value : '';
            updateFileInDB(it.id, { description: newDesc }).then(function(){ renderWorksGallery(); });
            edit._editing = false; edit.textContent = 'Editar';
          } else {
            var input = document.createElement('input'); input.type = 'text'; input.className = 'work-desc-input'; input.value = it.description || '';
            descEl.style.display = 'none'; descEl.parentNode.insertBefore(input, descEl);
            input.focus(); edit._editing = true; edit.textContent = 'Guardar';
          }
        });
        actions.appendChild(edit);
        meta.appendChild(actions);
        card.appendChild(meta);
        return card;
      }

      var galleryItems = [
        { name: 'galery1.png', type: 'image/png', src: 'assets/galery1.png', date: Date.now() - 5000, description: 'Trabajo de diseño 1' },
        { name: 'galery2.png', type: 'image/png', src: 'assets/galery2.png', date: Date.now() - 4000, description: 'Trabajo de diseño 2' },
        { name: 'galery3.png', type: 'image/png', src: 'assets/galery3.png', date: Date.now() - 3000, description: 'Trabajo de diseño 3' },
        { name: 'galery4.png', type: 'image/png', src: 'assets/galery4.png', date: Date.now() - 2000, description: 'Trabajo de diseño 4' },
        { name: 'galery5.png', type: 'image/png', src: 'assets/galery5.png', date: Date.now() - 1000, description: 'Trabajo de diseño 5' }
      ];
      function renderWorksGallery(){
        // Clear both targets
        if (worksGallery) worksGallery.innerHTML = '';
        if (portfolioGallery) portfolioGallery.innerHTML = '';
        if (!galleryItems || galleryItems.length === 0){
          var msg = '<p class="muted">No hay trabajos aún. Sube archivos para mostrarlos aquí.</p>';
          if (worksGallery) worksGallery.innerHTML = msg;
          if (portfolioGallery) portfolioGallery.innerHTML = msg;
          return;
        }
        // keep items in upload order (oldest -> newest) so gallery is predictable
        galleryItems.sort(function(a,b){ return (a.date||0) - (b.date||0); });
        var grid1 = document.createElement('div'); grid1.className = 'works-grid horizontal-2';
        galleryItems.forEach(function(it, idx){
          grid1.appendChild(createWorkCard(it, idx));
        });
        if (worksGallery) worksGallery.appendChild(grid1);
        // attach scroll listener to newly created scroller
        try { grid1.addEventListener('scroll', updateGalleryNav); } catch(e){}

        // Portfolio gallery: show scrollable grid with navigation buttons
        if (portfolioGallery) {
          portfolioGallery.innerHTML = '';
          var grid2 = document.createElement('div'); grid2.className = 'works-grid horizontal-2';
          galleryItems.forEach(function(it, idx){
            grid2.appendChild(createWorkCard(it, idx));
          });
          portfolioGallery.appendChild(grid2);
          // add navigation buttons
          var prevBtn = document.createElement('button'); prevBtn.className = 'gallery-nav-btn gallery-nav-left'; prevBtn.textContent = '‹'; prevBtn.setAttribute('aria-label', 'Anterior');
          var nextBtn = document.createElement('button'); nextBtn.className = 'gallery-nav-btn gallery-nav-right'; nextBtn.textContent = '›'; nextBtn.setAttribute('aria-label', 'Siguiente');
          portfolioGallery.appendChild(prevBtn);
          portfolioGallery.appendChild(nextBtn);
          // wire navigation
          function updateGalleryNav2(){
            if (!grid2) { prevBtn.disabled = true; nextBtn.disabled = true; return; }
            prevBtn.disabled = grid2.scrollLeft <= 0;
            nextBtn.disabled = grid2.scrollLeft + grid2.clientWidth >= grid2.scrollWidth - 1;
          }
          function scrollGalleryByPage2(dir){
            if (!grid2) return;
            var page = grid2.clientWidth;
            grid2.scrollTo({ left: grid2.scrollLeft + (dir * page), behavior: 'smooth' });
            setTimeout(updateGalleryNav2, 350);
          }
          prevBtn.onclick = function(){ scrollGalleryByPage2(-1); };
          nextBtn.onclick = function(){ scrollGalleryByPage2(1); };
          updateGalleryNav2();
          try { grid2.addEventListener('scroll', updateGalleryNav2); } catch(e){}
        }
        // Ensure gallery nav buttons exist and wire them up
        var galleryPrevBtn = document.getElementById('galleryPrevBtn');
        var galleryNextBtn = document.getElementById('galleryNextBtn');
        function updateGalleryNav(){
          var sc = worksGallery && worksGallery.querySelector('.works-grid.horizontal-2');
          if (!sc) { if (galleryPrevBtn) galleryPrevBtn.disabled = true; if (galleryNextBtn) galleryNextBtn.disabled = true; return; }
          if (galleryPrevBtn) galleryPrevBtn.disabled = sc.scrollLeft <= 0;
          if (galleryNextBtn) galleryNextBtn.disabled = sc.scrollLeft + sc.clientWidth >= sc.scrollWidth - 1;
        }
        function scrollGalleryByPage(dir){
          var sc = worksGallery && worksGallery.querySelector('.works-grid.horizontal-2');
          if (!sc) return;
          var page = sc.clientWidth; // approx two items width (shows 2 per view)
          sc.scrollTo({ left: sc.scrollLeft + (dir * page), behavior: 'smooth' });
          setTimeout(updateGalleryNav, 350);
        }
        // replace handlers (avoid duplicate listeners)
        if (galleryPrevBtn) galleryPrevBtn.onclick = function(){ scrollGalleryByPage(-1); };
        if (galleryNextBtn) galleryNextBtn.onclick = function(){ scrollGalleryByPage(1); };
        updateGalleryNav();
        // Keyboard navigation while worksPanel is open (single handler)
        if (!window._worksKeyHandler){
          window._worksKeyHandler = function(e){ if (worksPanel && worksPanel.classList.contains('open')){ if (e.key === 'ArrowLeft'){ scrollGalleryByPage(-1);} if (e.key === 'ArrowRight'){ scrollGalleryByPage(1);} } };
          document.addEventListener('keydown', window._worksKeyHandler);
        }
      }

      // Upload queue rendering and handling
      function renderUploadQueue(){
        if (!uploadQueue) return;
        uploadQueue.innerHTML = '';
        if (!pendingUploads || pendingUploads.length === 0){
          uploadQueue.innerHTML = '<p class="muted">No hay archivos en cola.</p>';
          return;
        }
        var list = document.createElement('div'); list.className = 'upload-list';
        pendingUploads.forEach(function(item, idx){
          var row = document.createElement('div'); row.className = 'upload-row';
          var info = document.createElement('div'); info.className = 'upload-info'; info.textContent = item.file.name; row.appendChild(info);
          var desc = document.createElement('input'); desc.type = 'text'; desc.placeholder = 'Descripción (opcional)'; desc.className = 'upload-desc'; desc.value = item.description || '';
          desc.addEventListener('input', function(e){ pendingUploads[idx].description = e.target.value; });
          row.appendChild(desc);
          var btnUpload = document.createElement('button'); btnUpload.className = 'btn small'; btnUpload.textContent = 'Subir'; btnUpload.addEventListener('click', function(){ addFileToDB(item.file, item.description).then(function(){ pendingUploads.splice(idx,1); renderUploadQueue(); renderWorksGallery(); }); });
          row.appendChild(btnUpload);
          var btnRemove = document.createElement('button'); btnRemove.className = 'btn small danger'; btnRemove.style.marginLeft = '8px'; btnRemove.textContent = 'Remover'; btnRemove.addEventListener('click', function(){ pendingUploads.splice(idx,1); renderUploadQueue(); });
          row.appendChild(btnRemove);
          list.appendChild(row);
        });
        var uploadAll = document.createElement('button'); uploadAll.className = 'btn'; uploadAll.textContent = 'Subir todos'; uploadAll.addEventListener('click', function(){ Promise.all(pendingUploads.map(function(it){ return addFileToDB(it.file, it.description); })).then(function(){ pendingUploads = []; renderUploadQueue(); renderWorksGallery(); }); });
        uploadQueue.appendChild(list);
        uploadQueue.appendChild(uploadAll);
      }

      // Lightbox functions
      var lightbox = null;
      var lightboxImg = null;
      var lightboxCaption = null;
      var currentLightboxIndex = -1;
      var lightboxInitialized = false;
      function ensureLightboxElements(){
        if (lightboxInitialized) return;
        lightbox = document.getElementById('lightbox');
        lightboxImg = document.getElementById('lightboxImg');
        lightboxCaption = document.getElementById('lightboxCaption');
        var prev = document.getElementById('lightboxPrev');
        var next = document.getElementById('lightboxNext');
        var close = document.getElementById('lightboxClose');
        if (prev) prev.addEventListener('click', function(){ showLightbox((currentLightboxIndex-1+galleryItems.length)%galleryItems.length); });
        if (next) next.addEventListener('click', function(){ showLightbox((currentLightboxIndex+1)%galleryItems.length); });
        if (close) close.addEventListener('click', hideLightbox);
        if (lightbox) { lightbox.addEventListener('click', function(e){ if (e.target === lightbox) hideLightbox(); }); }
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') hideLightbox(); if (e.key === 'ArrowLeft') showLightbox((currentLightboxIndex-1+galleryItems.length)%galleryItems.length); if (e.key === 'ArrowRight') showLightbox((currentLightboxIndex+1)%galleryItems.length); });
        lightboxInitialized = true;
      }

      function showLightbox(index){
        if (!galleryItems || galleryItems.length === 0) return;
        currentLightboxIndex = index;
        ensureLightboxElements();
        var item = galleryItems[index];
        var url = item.src || URL.createObjectURL(item.blob);
        lightboxImg.src = url;
        lightboxCaption.textContent = item.name + (item.description ? (' — ' + item.description) : '');
        lightbox.classList.add('open');
        lightbox.setAttribute('aria-hidden','false');
      }

      function hideLightbox(){
        if (!lightbox) return;
        lightbox.classList.remove('open');
        lightbox.setAttribute('aria-hidden','true');
        if (lightboxImg) lightboxImg.src = '';
      }

      // File input / drag & drop
      browseBtn && browseBtn.addEventListener('click', function(){ fileInput.click(); });
      fileInput && fileInput.addEventListener('change', function(e){ var files = Array.from(e.target.files || []); files.forEach(function(f){ pendingUploads.push({ file: f, description: '' }); }); renderUploadQueue(); e.target.value = ''; });
      uploadArea && uploadArea.addEventListener('dragover', function(e){ e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea && uploadArea.addEventListener('dragleave', function(e){ uploadArea.classList.remove('dragover'); });
      uploadArea && uploadArea.addEventListener('drop', function(e){ e.preventDefault(); uploadArea.classList.remove('dragover'); var files = Array.from(e.dataTransfer.files || []); files.forEach(function(f){ pendingUploads.push({ file: f, description: '' }); }); renderUploadQueue(); });
      // Ensure gallery renders initially into Portafolio when page loads
      renderWorksGallery();
    });
  </script>
</body>
</html>
